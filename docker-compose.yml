version: "3.8"

services:
  gws_mcp:
    build: .
    container_name: gws_mcp
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      PORT: ${PORT:-3000}
      DATABASE_URL: "${DATABASE_URL:-sqlite:///data/mcp.db}"
      MASTER_KEY: "${MASTER_KEY:?MASTER_KEY environment variable is required. Generate with: openssl rand -hex 32}"
      API_KEY_MODE: ${API_KEY_MODE:-user_bound}
      REDIRECT_URI_ALLOWLIST: "${REDIRECT_URI_ALLOWLIST:-https://chatgpt.com/,https://chat.openai.com/,localhost,127.0.0.1}"
      REDIRECT_URI_ALLOWLIST_MODE: ${REDIRECT_URI_ALLOWLIST_MODE:-prefix}
      CODE_TTL_SECONDS: ${CODE_TTL_SECONDS:-90}
      TOKEN_TTL_SECONDS: ${TOKEN_TTL_SECONDS:-3600}
      GOOGLE_MCP_CREDENTIALS_DIR: /app/store_creds
      # Google OAuth (required for OAuth flow)
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID:-}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET:-}
      # Development Settings (set to true for localhost testing)
      OAUTH2_ALLOW_INSECURE_TRANSPORT: ${OAUTH2_ALLOW_INSECURE_TRANSPORT:-false}
      OAUTH2_ENABLE_DEBUG: ${OAUTH2_ENABLE_DEBUG:-false}
      # Legacy Compatibility (recommended during migration)
      OAUTH2_ENABLE_LEGACY_AUTH: ${OAUTH2_ENABLE_LEGACY_AUTH:-true}
    volumes:
      - ./client_secret.json:/app/client_secret.json:ro
      - ./data:/data:rw
      - ./store_creds:/app/store_creds:rw
    env_file:
      - .env
    restart: unless-stopped
